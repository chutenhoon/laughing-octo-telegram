<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title data-i18n-key="product.detail.pageTitle">Product detail | polyflux.xyz</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="../../android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="../../android-chrome-512x512.png" />
    <link rel="manifest" href="../../site.webmanifest" />
    <link rel="icon" href="../../favicon.ico" />
    <meta name="description" content="S&#224;n th&#432;&#417;ng m&#7841;i &#273;i&#7879;n t&#7917; uy t&#237;n, giao nhanh, b&#7843;o h&#224;nh r&#245; r&#224;ng, h&#7895; tr&#7907; 24/7." />
    <meta property="og:title" content="polyflux.xyz" />
    <meta property="og:description" content="S&#224;n th&#432;&#417;ng m&#7841;i &#273;i&#7879;n t&#7917; uy t&#237;n, giao nhanh, b&#7843;o h&#224;nh r&#245; r&#224;ng, h&#7895; tr&#7907; 24/7." />
    <meta property="og:image" content="../../asset/logo-preview.png" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="vi_VN" />
    <meta property="og:site_name" content="polyflux.xyz" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="polyflux.xyz" />
    <meta name="twitter:description" content="S&#224;n th&#432;&#417;ng m&#7841;i &#273;i&#7879;n t&#7917; uy t&#237;n, giao nhanh, b&#7843;o h&#224;nh r&#245; r&#224;ng, h&#7895; tr&#7907; 24/7." />
    <meta name="twitter:image" content="../../asset/logo-preview.png" />
<link rel="stylesheet" href="../../asset/base.css" />
  </head>
  <body>
    <video class="video-bg" autoplay muted loop playsinline preload="metadata">
      <source src="../../asset/bg-donut.mp4" type="video/mp4" />
    </video>
    <div class="video-overlay"></div>

    <!-- Navbar -->
    <header class="wrap">
      <nav class="nav glass">
        <a href="/" class="brand" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
          <img src="../../asset/logo.png" alt="PolyFlux" />
          <span>polyflux<b>.xyz</b></span>
        </a>
        <div class="nav-links">
          <a href="/sanpham/" data-nav="sanpham">S&#7843;n Ph&#7849;m <span class="badge">HOT</span></a>
          <a href="/dichvu/" data-nav="dichvu">D&#7883;ch V&#7909;</a>
          <a href="/nhiemvu/" data-nav="nhiemvu">Nhi&#7879;m V&#7909;</a>
          <a href="/profile/topups/" data-nav="topups">N&#7841;p ti&#7873;n</a>
        </div>
        <div class="nav-actions">
                    <button class="btn balance-btn" data-balance type="button">0 VND</button>
          <a class="btn login-btn" href="/login/">Login</a>
        </div>
      </nav>
    </header>

    <main class="wrap">
      <section class="product-detail">
        <div class="detail-breadcrumb">
          <a href="/" id="crumb-home" data-i18n-key="breadcrumb.home">Home</a>
          <span>/</span>
          <a href="/sanpham/" id="crumb-category" data-i18n-key="nav.products">Products</a>
          <span>/</span>
          <span id="crumb-title" data-i18n-key="breadcrumb.detail">Detail</span>
        </div>

        <div class="detail-grid">
          <div class="card detail-media-card">
            <div class="detail-image" id="detail-image"></div>
            <div class="detail-actions">
              <button class="btn ghost" id="detail-share" type="button" data-i18n-key="product.detail.share">Share</button>
              <button class="btn ghost" id="detail-favorite" type="button" data-i18n-key="product.detail.favorite">Favorite</button>
            </div>
          </div>

          <div class="card detail-panel">
            <h1 class="detail-title" id="detail-title">--</h1>
            <p class="detail-short" id="detail-short"></p>

            <div class="detail-meta">
              <div class="meta-col meta-stats">
                <span><span data-i18n-key="label.stock">Stock</span>: <strong id="detail-stock">--</strong></span>
                <span><span data-i18n-key="label.sold">Sold</span>: <strong id="detail-sold">--</strong></span>
                <span><span data-i18n-key="label.rating">Rating</span>: <strong id="detail-rating">--</strong></span>
                <span><span data-i18n-key="label.type">Type</span>: <strong id="detail-type">--</strong></span>
              </div>
              <div class="meta-col meta-seller">
                <span class="seller-line">
                  <span class="seller-label" data-i18n-key="label.seller">Seller</span>:
                  <span class="seller-value"><strong class="seller-name"><a id="detail-seller-link" href="#">--</a></strong><span id="detail-seller-badge"></span></span>
                </span>
                <span><span data-i18n-key="product.detail.shopIdLabel">Shop ID</span>: <strong id="detail-shop-id">--</strong></span>
                <span><span data-i18n-key="label.rating">Rating</span>: <strong id="detail-rating-note" class="rating-note"></strong></span>
              </div>
            </div>

            <div class="detail-price" id="detail-price">--</div>

            <div class="detail-other">
              <h4 data-i18n-key="product.detail.otherTitle">Other items from this shop</h4>
              <div class="detail-other-list" id="detail-other-list"></div>
            </div>

            <div class="detail-cta">
              <button class="btn primary" id="detail-order" type="button" data-requires-login data-auth-action="checkout" data-i18n-key="product.detail.order">Place order</button>
              <button class="btn" id="detail-preorder" type="button" data-requires-login data-auth-action="checkout" data-i18n-key="product.detail.preorder">Preorder</button>
              <a class="btn ghost" id="detail-message" href="#" target="_blank" rel="noreferrer" data-i18n-key="product.detail.message">Message</a>
            </div>
          </div>
        </div>

        <div class="card detail-tabs">
          <div class="tabs-head">
            <button class="tab active" type="button" data-tab="shop" data-i18n-key="product.detail.tab.shop">Shop description</button>
            <button class="tab" type="button" data-tab="reviews" data-i18n-key="product.detail.tab.reviews">Reviews</button>
            <button class="tab" type="button" data-tab="api" data-i18n-key="product.detail.tab.api">T&#7921; &#273;&#7897;ng</button>
          </div>
          <div class="tabs-body">
            <div class="tab-panel active" data-tab="shop" id="detail-shop-desc"></div>
            <div class="tab-panel" data-tab="reviews" id="detail-reviews"></div>
            <div class="tab-panel" data-tab="api" id="detail-api"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer>
      <div class="footer-grid">
        <div>
          <h4>About polyflux.xyz</h4>
          <p>
            The #1 trusted marketplace for digital assets on polyflux.xyz. Buy accounts, emails, tools and more with
            instant delivery.
          </p>
        </div>
        <div>
          <h4>&#272;i&#7873;u h&#432;&#7899;ng</h4>
          <p><a href="/sanpham/">S&#7843;n ph&#7849;m</a></p>
          <p><a href="/dichvu/">D&#7883;ch v&#7909;</a></p>
          <p><a href="/nhiemvu/">Nhi&#7879;m v&#7909; marketplace</a></p>
          <p><a href="/profile/">T&#224;i kho&#7843;n c&#7911;a t&#244;i</a></p>
        </div>
        <div>
          <h4>Thanh to&#225;n &amp; b&#7843;o m&#7853;t</h4>
          <p>20+ ph&#432;&#417;ng th&#7913;c thanh to&#225;n, x&#7917; l&#253; t&#7921; &#273;&#7897;ng.</p>
          <p>L&#7883;ch s&#7917; &#273;&#417;n h&#224;ng minh b&#7841;ch.</p>
          <p>2FA &amp; c&#7843;nh b&#225;o &#273;&#259;ng nh&#7853;p kh&#7843; nghi.</p>
        </div>
        <div>
          <h4>Tham gia b&#225;n h&#224;ng</h4>
          <p>Mu&#7889;n m&#7903; gian h&#224;ng tr&#234;n polyflux.xyz?</p>
          <a
            href="/seller/join/"
            class="btn primary"
            style="margin-top: 8px; display: inline-flex; align-items: center; gap: 6px;"
          >
            Tham gia b&#225;n h&#224;ng
          </a>
        </div>
      </div>
    </footer>

    <!-- Mobile nav -->
    <nav class="mobile-nav">
      <div class="mobile-nav-top">
        <a href="/" class="mobile-brand" style="display: flex; align-items: center; gap: 10px; text-decoration: none;">
          <img src="../../asset/logo.png" alt="PolyFlux" />
          <span>polyflux<b>.xyz</b></span>
        </a>
        <div class="mobile-actions">
                    <button class="btn balance-btn" data-balance type="button">0 VND</button>
          <a class="btn login-btn" href="/login/">Login</a>
        
          <button class="menu-btn" id="mobile-menu" type="button" aria-label="Menu">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
      </div>
      <div class="mobile-links">
        <a href="/sanpham/" data-nav="sanpham">S&#7843;n Ph&#7849;m</a>
        <a href="/dichvu/" data-nav="dichvu">D&#7883;ch V&#7909;</a>
        <a href="/nhiemvu/" data-nav="nhiemvu">Nhi&#7879;m V&#7909;</a>
        <a href="/profile/topups/" data-nav="topups">N&#7841;p ti&#7873;n</a>
      </div>
    </nav>

    <div class="modal-backdrop order-modal" id="order-modal" aria-hidden="true">
      <div class="modal-card order-modal-card" role="dialog" aria-modal="true" aria-labelledby="order-modal-title">
        <div class="order-modal-head">
          <h3 id="order-modal-title" data-i18n-key="product.detail.modal.title">Confirm order</h3>
          <button class="btn ghost order-modal-close" id="order-modal-close" type="button" aria-label="Close" data-i18n-aria="support.close">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div class="order-modal-body">
          <div class="order-modal-product">
            <strong id="order-modal-name">--</strong>
            <span class="order-modal-price" id="order-modal-price">--</span>
          </div>
          <div class="order-modal-qty">
            <span data-i18n-key="product.detail.modal.quantity">Quantity</span>
            <div class="order-qty-control">
              <button class="btn ghost qty-btn" id="order-qty-minus" type="button">-</button>
              <input id="order-qty-input" type="number" min="1" step="1" value="1" inputmode="numeric" />
              <button class="btn ghost qty-btn" id="order-qty-plus" type="button">+</button>
            </div>
            <span id="order-qty-note"></span>
          </div>
          <div class="order-modal-total">
            <span data-i18n-key="product.detail.modal.subtotal">Subtotal</span>
            <strong id="order-modal-total">--</strong>
          </div>
          <div class="order-modal-error" id="order-modal-error"></div>
        </div>
        <div class="modal-actions">
          <button class="btn ghost" id="order-modal-cancel" type="button" data-i18n-key="product.detail.modal.cancel">Cancel</button>
          <button class="btn primary" id="order-modal-confirm" type="button" data-i18n-key="product.detail.modal.confirm">Confirm order</button>
        </div>
      </div>
    </div>

    <script src="../../asset/render.js"></script>
    <script>
      (async function initDetail() {
        let currentLanguage = typeof getCurrentLanguage === "function" ? getCurrentLanguage() : "vi";
        const t = (key, fallback, vars) =>
          typeof formatI18n === "function" ? formatI18n(currentLanguage, key, fallback, vars) : fallback || key;

        const products = await loadJSON("../../data/mock-products.json");
        const sellers = await loadJSON("../../data/mock-sellers.json");
        const params = new URLSearchParams(window.location.search);
        const normalizeId = (value) => (value == null ? "" : String(value).trim());
        const findProductById = (id) => {
          const cleaned = normalizeId(id);
          if (!cleaned) return null;
          return (
            products.find((p) => String(p.id) === cleaned) ||
            products.find((p) => String(p.id).toLowerCase() === cleaned.toLowerCase())
          );
        };
        const productIdRaw = params.get("id");
        const productId = productIdRaw ? productIdRaw.trim() : "";
        let currentProduct = productId ? findProductById(productId) : products[0];
        const getShopGroup = (product) => {
          if (!product) return "";
          const raw = product.shopId || product.groupId || product.collectionId || product.id;
          return raw == null ? "" : String(raw).trim();
        };

        const categoryKeys = {
          email: "product.category.email",
          tool: "product.category.tool",
          account: "product.category.account",
          other: "product.category.other",
        };
        const getCategoryLabel = (key) => {
          const labelKey = categoryKeys[key];
          return labelKey ? t(labelKey, key) : key || "";
        };

        const shopDescriptions = {
          "bk-main": () => `
            <strong>${t("product.detail.shop.polyflux.title", "PolyFlux Official")}</strong>
            <ul style="margin-top:8px; padding-left: 18px;">
              <li>${t("product.detail.shop.polyflux.bullet1", "Fast delivery and pre-check before handoff.")}</li>
              <li>${t("product.detail.shop.polyflux.bullet2", "Refunds if issues cannot be resolved.")}</li>
              <li>${t("product.detail.shop.polyflux.bullet3", "24/7 support via Telegram.")}</li>
            </ul>
          `,
          "partner-1": () => `
            <strong>${t("product.detail.shop.partner.title", "Partner Marketplace #1")}</strong>
            <ul style="margin-top:8px; padding-left: 18px;">
              <li>${t("product.detail.shop.partner.bullet1", "Stable inventory, fast delivery within minutes.")}</li>
              <li>${t("product.detail.shop.partner.bullet2", "Best pricing for bulk orders.")}</li>
              <li>${t("product.detail.shop.partner.bullet3", "Warranty support per published policy.")}</li>
            </ul>
          `,
        };
        const getShopDescription = (sellerId) => {
          const render = sellerId ? shopDescriptions[sellerId] : null;
          if (render) return render();
          return `
            <strong>${t("product.detail.shop.fallbackTitle", "Trusted shop")}</strong>
            <ul style="margin-top:8px; padding-left: 18px;">
              <li>${t("product.detail.shop.fallbackBullet1", "Check the item right after delivery.")}</li>
              <li>${t("product.detail.shop.fallbackBullet2", "Support is available if issues arise.")}</li>
            </ul>
          `;
        };

        const reviews = [
          {
            name: "Minh Q.",
            rating: 4.9,
            textKey: "product.detail.review.1.text",
            textFallback: "Fast delivery, the accounts work great.",
            timeKey: "product.detail.review.1.time",
            timeFallback: "2 hours ago",
          },
          {
            name: "Hanh L.",
            rating: 4.7,
            textKey: "product.detail.review.2.text",
            textFallback: "Quick support and clear warranty coverage.",
            timeKey: "product.detail.review.2.time",
            timeFallback: "1 day ago",
          },
          {
            name: "Duy P.",
            rating: 4.6,
            textKey: "product.detail.review.3.text",
            textFallback: "Accurate description, will buy again.",
            timeKey: "product.detail.review.3.time",
            timeFallback: "3 days ago",
          },
        ];

        const renderSellerBadge = (data) => {
          if (!data || !data.badge) return "";
          const raw = String(data.badge || "").trim().toUpperCase();
          if (!raw) return "";
          if (raw === "ADMIN") {
            return `<span class="seller-badge admin">${t("seller.badge.admin", "Admin")}</span>`;
          }
          if (raw === "VERIFIED") {
            return `<span class="seller-badge verified">${t("seller.badge.verified", "Verified")}</span>`;
          }
          if (raw.startsWith("MERCHANT-")) {
            const tier = raw.replace("MERCHANT-", "");
            const tierClass = tier.toLowerCase();
            const tierLabel = t("seller.badge.merchant", `Merchant tier ${tier}`, { tier });
            return `<span class="seller-badge merchant merchant-${tierClass}">${tierLabel}</span>`;
          }
          return "";
        };

        const setText = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value == null ? "--" : value;
        };
        const setHTML = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = value == null ? "--" : value;
        };

        const root = getProjectRoot();
        const isFile = window.location.protocol === "file:";
        const crumbHome = document.getElementById("crumb-home");
        if (crumbHome) {
          crumbHome.href = root + (isFile ? "index.html" : "");
        }

        const updateUrl = (id) => {
          const cleaned = normalizeId(id);
          if (!cleaned) return;
          const url = new URL(window.location.href);
          url.searchParams.set("id", cleaned);
          window.history.replaceState({}, "", url.toString());
        };

        const getOrdersUrl = () => root + (isFile ? "profile/orders/index.html" : "profile/orders/");

        const renderProduct = (product) => {
          if (!product) {
            setHTML("detail-title", t("product.detail.notFound", "Product not found"));
            return;
          }

          const seller = sellers.find((s) => String(s.id) === String(product.sellerId)) || null;
          const rating = product.rating != null ? product.rating : seller ? seller.rating : null;
          const hasRating = typeof rating === "number";
          const ratingNote = hasRating
            ? rating >= 4.5
              ? t("product.detail.rating.positive", "Positive")
              : rating >= 4
                ? t("product.detail.rating.neutral", "Neutral")
                : t("product.detail.rating.negative", "Needs improvement")
            : t("product.detail.rating.none", "No rating yet");
          const ratingClass = hasRating ? (rating >= 4.5 ? "positive" : rating >= 4 ? "neutral" : "negative") : "";

          const nameKey = product.id ? `product.data.${product.id}.name` : "";
          const shortKey = product.id ? `product.data.${product.id}.short` : "";
          const productName = nameKey ? t(nameKey, product.name || "--") : product.name || "--";
          const productShort = shortKey ? t(shortKey, product.short || "") : product.short || "";

          setText("detail-title", productName);
          if (productShort) {
            setText("detail-short", productShort);
          } else {
            setHTML("detail-short", t("product.detail.description.pending", "Description is updating."));
          }
          setText("detail-stock", product.stock ?? "--");
          setText("detail-sold", product.orders ?? "--");
          setText("detail-rating", rating != null ? rating : "--");
          setText("detail-type", product.subcategory || (getCategoryLabel(product.category) || "--"));

          const sellerLink = document.getElementById("detail-seller-link");
          if (sellerLink) {
            sellerLink.textContent = seller ? seller.name : t("product.detail.shop.polyflux.title", "PolyFlux Official");
            const sellerPath = isFile ? "seller/[id]/index.html" : "seller/[id]/";
            sellerLink.href = root + sellerPath + (seller ? `?id=${encodeURIComponent(seller.id)}` : "");
          }
          setText("detail-shop-id", seller ? seller.id : "--");

          const breadcrumbCategory = document.getElementById("crumb-category");
          if (breadcrumbCategory) {
            const categoryKey = categoryKeys[product.category] || "nav.products";
            breadcrumbCategory.innerHTML = getCategoryLabel(product.category) || t("nav.products", "Products");
            breadcrumbCategory.dataset.i18nKey = categoryKey;
            breadcrumbCategory.href = root + (isFile ? "sanpham/index.html" : "sanpham/");
          }
          setText("crumb-title", productName || t("breadcrumb.detail", "Detail"));

          const priceLabel = formatPriceRange(product);
          setText("detail-price", priceLabel);
          const detailPriceEl = document.getElementById("detail-price");
          if (detailPriceEl) {
            const hasRange = typeof product.priceMax === "number" && product.priceMax > product.price;
            detailPriceEl.dataset.baseCurrency = "VND";
            if (hasRange) {
              detailPriceEl.dataset.baseMin = String(product.price);
              detailPriceEl.dataset.baseMax = String(product.priceMax);
              delete detailPriceEl.dataset.baseAmount;
            } else {
              detailPriceEl.dataset.baseAmount = String(product.price);
              delete detailPriceEl.dataset.baseMin;
              delete detailPriceEl.dataset.baseMax;
            }
            if (window.BKCurrency && typeof window.BKCurrency.applyToDom === "function") {
              window.BKCurrency.applyToDom(detailPriceEl.parentElement || detailPriceEl);
            }
          }

          const ratingNoteEl = document.getElementById("detail-rating-note");
          if (ratingNoteEl) {
            ratingNoteEl.innerHTML = ratingNote;
            ratingNoteEl.classList.remove("positive", "neutral", "negative");
            if (ratingClass) {
              ratingNoteEl.classList.add(ratingClass);
            }
          }

          const badgeEl = document.getElementById("detail-seller-badge");
          if (badgeEl) {
            badgeEl.innerHTML = renderSellerBadge(seller);
          }

          const imageEl = document.getElementById("detail-image");
          if (imageEl) {
            if (product.image) {
              imageEl.innerHTML = `<img src="${root + product.image}" alt="${productName}" loading="lazy" />`;
            } else {
              imageEl.textContent = (product.subcategory || productName || "BK").slice(0, 2);
            }
          }

          const otherListEl = document.getElementById("detail-other-list");
          if (otherListEl) {
            const shopGroup = getShopGroup(product);
            const others = products.filter((p) => getShopGroup(p) === shopGroup && String(p.id) !== String(product.id));
            if (!others.length) {
              otherListEl.innerHTML = `<div class="empty-state">${t("product.detail.other.empty", "No other items yet.")}</div>`;
            } else {
              otherListEl.innerHTML = others
                .map((item) => {
                  const itemNameKey = item.id ? `product.data.${item.id}.name` : "";
                  const itemName = itemNameKey ? t(itemNameKey, item.name || "") : item.name || "";
                  const priceLabel = formatPriceRange(item);
                  const priceAttrs =
                    typeof item.priceMax === "number" && item.priceMax > item.price
                      ? `data-base-min="${item.price}" data-base-max="${item.priceMax}" data-base-currency="VND"`
                      : `data-base-amount="${item.price}" data-base-currency="VND"`;
                  return `
                  <a class="detail-other-item" data-product-id="${item.id}" href="${getProductDetailPath(item.id)}">
                    <span>${itemName}</span>
                    <span class="detail-other-meta">
                      <span class="price" ${priceAttrs}>${priceLabel}</span>
                      <span class="badge-soft">${t("label.stock", "Stock")}: ${item.stock ?? "--"}</span>
                    </span>
                  </a>
                `;
                })
                .join("");
            }
          }

          if (otherListEl && window.BKCurrency && typeof window.BKCurrency.applyToDom === "function") {
            window.BKCurrency.applyToDom(otherListEl);
          }

          const messageBtn = document.getElementById("detail-message");
          if (messageBtn) {
            messageBtn.href = (seller && seller.contact) || "https://t.me/DTPlatinum";
          }

          const shopDesc = document.getElementById("detail-shop-desc");
          if (shopDesc) {
            shopDesc.innerHTML = getShopDescription(seller ? seller.id : "");
          }

          const reviewBox = document.getElementById("detail-reviews");
          if (reviewBox) {
            reviewBox.innerHTML = reviews
              .map((r) => {
                const reviewText = t(r.textKey, r.textFallback || "");
                const reviewTime = t(r.timeKey, r.timeFallback || "");
                return `
                <div class="detail-review">
                  <div style="display:flex; justify-content: space-between; gap: 12px;">
                    <strong>${r.name}</strong>
                    <span style="color: var(--muted); font-size: 12px;">${reviewTime}</span>
                  </div>
                  <div style="margin-top:4px;">${t("label.rating", "Rating")}: <strong>${r.rating}</strong></div>
                  <div style="margin-top:6px;">${reviewText}</div>
                </div>
              `;
              })
              .join("");
          }

          const apiBox = document.getElementById("detail-api");
          if (apiBox) {
            apiBox.innerHTML = `
            <strong>${t("product.detail.api.title", "Automated delivery")}</strong>
            <ul style="margin-top:8px; padding-left: 18px;">
              <li>${t("product.detail.api.bullet1", "Auto-deliver after payment.")}</li>
              <li>${t("product.detail.api.bullet2", "Fast integration support.")}</li>
              <li>${t("product.detail.api.bullet3", "Contact support to enable this.")}</li>
            </ul>
          `;
          }

          const orderBtn = document.getElementById("detail-order");
          const preorderBtn = document.getElementById("detail-preorder");
          if (orderBtn && preorderBtn) {
            const auth = window.BKAuth ? window.BKAuth.read() : { loggedIn: false };
            if (!auth.loggedIn) {
              orderBtn.disabled = true;
              preorderBtn.disabled = true;
              orderBtn.classList.add("is-locked");
              preorderBtn.classList.add("is-locked");
            } else {
              const inStock = (product.stock ?? 0) > 0;
              orderBtn.disabled = !inStock;
              preorderBtn.disabled = inStock;
              orderBtn.classList.remove("is-locked");
              preorderBtn.classList.remove("is-locked");
            }
          }
        };

        renderProduct(currentProduct);

        const selectProduct = (id) => {
          const next = findProductById(id);
          if (!next) return;
          currentProduct = next;
          renderProduct(currentProduct);
          updateUrl(currentProduct.id);
        };

        const otherList = document.getElementById("detail-other-list");
        if (otherList) {
          otherList.addEventListener("click", (event) => {
            const link = event.target.closest(".detail-other-item");
            if (!link) return;
            if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button === 1) return;
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            const productId = link.dataset.productId;
            if (productId) {
              selectProduct(productId);
            }
          });
        }

        const orderModal = document.getElementById("order-modal");
        const orderModalName = document.getElementById("order-modal-name");
        const orderModalPrice = document.getElementById("order-modal-price");
        const orderModalTotal = document.getElementById("order-modal-total");
        const orderModalError = document.getElementById("order-modal-error");
        const orderQtyInput = document.getElementById("order-qty-input");
        const orderQtyMinus = document.getElementById("order-qty-minus");
        const orderQtyPlus = document.getElementById("order-qty-plus");
        const orderQtyNote = document.getElementById("order-qty-note");
        const orderConfirm = document.getElementById("order-modal-confirm");
        const orderCancel = document.getElementById("order-modal-cancel");
        const orderClose = document.getElementById("order-modal-close");
        const orderBtn = document.getElementById("detail-order");
        let orderLoading = false;

        const notify = (message) => {
          if (!message) return;
          if (window.BKAuth && typeof window.BKAuth.showToast === "function") {
            window.BKAuth.showToast(message);
          } else {
            alert(message);
          }
        };

        const showOrderToast = () => {
          const message = t(
            "product.detail.toast.success",
            "Order placed successfully. Check your orders."
          );
          let toast = document.querySelector(".order-toast");
          if (!toast) {
            toast = document.createElement("div");
            toast.className = "order-toast";
            toast.setAttribute("role", "status");
            toast.setAttribute("aria-live", "polite");
            const text = document.createElement("span");
            text.className = "order-toast-text";
            const action = document.createElement("a");
            action.className = "btn primary order-toast-action";
            action.textContent = t("product.detail.toast.viewOrders", "View orders");
            action.href = getOrdersUrl();
            toast.append(text, action);
            document.body.appendChild(toast);
          }
          const textEl = toast.querySelector(".order-toast-text");
          if (textEl) textEl.textContent = message;
          const actionEl = toast.querySelector(".order-toast-action");
          if (actionEl) {
            actionEl.textContent = t("product.detail.toast.viewOrders", "View orders");
            actionEl.href = getOrdersUrl();
          }
          toast.classList.add("show");
          clearTimeout(showOrderToast._timer);
          showOrderToast._timer = setTimeout(() => {
            toast.classList.remove("show");
          }, 7000);
        };

        const getStockLimit = () => {
          const stock = Number(currentProduct && currentProduct.stock);
          if (Number.isFinite(stock) && stock > 0) return Math.floor(stock);
          return 1;
        };

        const setQty = (value) => {
          if (!orderQtyInput) return;
          const maxQty = getStockLimit();
          const cleaned = String(value || "").replace(/[^\d]/g, "");
          let next = Number(cleaned);
          if (!Number.isFinite(next) || next < 1) next = 1;
          if (next > maxQty) next = maxQty;
          orderQtyInput.value = String(next);
          if (orderQtyMinus) orderQtyMinus.disabled = next <= 1;
          if (orderQtyPlus) orderQtyPlus.disabled = next >= maxQty;
          if (orderQtyNote) {
            orderQtyNote.textContent =
              maxQty > 0 ? t("product.detail.modal.max", "Max {max}", { max: maxQty }) : "";
          }
          const price = Number(currentProduct && currentProduct.price) || 0;
          const priceMax = Number(currentProduct && currentProduct.priceMax);
          const hasRange = Number.isFinite(priceMax) && priceMax > price;
          if (orderModalTotal) {
            orderModalTotal.dataset.baseCurrency = "VND";
            if (hasRange) {
              orderModalTotal.dataset.baseMin = String(price * next);
              orderModalTotal.dataset.baseMax = String(priceMax * next);
              delete orderModalTotal.dataset.baseAmount;
            } else {
              orderModalTotal.dataset.baseAmount = String(price * next);
              delete orderModalTotal.dataset.baseMin;
              delete orderModalTotal.dataset.baseMax;
            }
          }
          if (window.BKCurrency && typeof window.BKCurrency.applyToDom === "function" && orderModal) {
            window.BKCurrency.applyToDom(orderModal);
          }
        };

        const syncOrderModal = () => {
          if (!currentProduct) return;
          if (orderModalName) orderModalName.textContent = currentProduct.name || "--";
          const price = Number(currentProduct.price) || 0;
          const priceMax = Number(currentProduct.priceMax);
          const hasRange = Number.isFinite(priceMax) && priceMax > price;
          if (orderModalPrice) {
            orderModalPrice.dataset.baseCurrency = "VND";
            if (hasRange) {
              orderModalPrice.dataset.baseMin = String(price);
              orderModalPrice.dataset.baseMax = String(priceMax);
              delete orderModalPrice.dataset.baseAmount;
            } else {
              orderModalPrice.dataset.baseAmount = String(price);
              delete orderModalPrice.dataset.baseMin;
              delete orderModalPrice.dataset.baseMax;
            }
          }
          if (orderModalError) orderModalError.textContent = "";
          const maxQty = getStockLimit();
          if (orderQtyInput) {
            orderQtyInput.max = String(maxQty);
            orderQtyInput.min = "1";
          }
          setQty(1);
        };

        const openOrderModal = () => {
          if (!orderModal) return;
          syncOrderModal();
          orderModal.classList.add("open");
          orderModal.setAttribute("aria-hidden", "false");
          document.body.classList.add("modal-open");
          if (orderQtyInput) orderQtyInput.focus();
        };

        const closeOrderModal = () => {
          if (!orderModal) return;
          orderModal.classList.remove("open");
          orderModal.setAttribute("aria-hidden", "true");
          document.body.classList.remove("modal-open");
          if (orderConfirm) {
            orderConfirm.disabled = false;
            orderConfirm.innerHTML = t("product.detail.modal.confirm", "Confirm order");
          }
          orderLoading = false;
        };

        const placeOrder = (productId, quantity) =>
          new Promise((resolve) => {
            setTimeout(() => resolve({ ok: true }), 900);
          });

        if (orderModal) {
          orderModal.addEventListener("click", (event) => {
            if (event.target === orderModal) {
              closeOrderModal();
            }
          });
        }

        if (orderCancel) orderCancel.addEventListener("click", closeOrderModal);
        if (orderClose) orderClose.addEventListener("click", closeOrderModal);

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && orderModal && orderModal.classList.contains("open")) {
            closeOrderModal();
          }
        });

        if (orderQtyMinus) {
          orderQtyMinus.addEventListener("click", () => {
            const current = Number(orderQtyInput && orderQtyInput.value) || 1;
            setQty(current - 1);
          });
        }

        if (orderQtyPlus) {
          orderQtyPlus.addEventListener("click", () => {
            const current = Number(orderQtyInput && orderQtyInput.value) || 1;
            setQty(current + 1);
          });
        }

        if (orderQtyInput) {
          orderQtyInput.addEventListener("input", () => {
            setQty(orderQtyInput.value);
          });
          orderQtyInput.addEventListener("blur", () => {
            setQty(orderQtyInput.value);
          });
        }

        if (orderConfirm) {
          orderConfirm.addEventListener("click", async () => {
            if (orderLoading || !currentProduct) return;
            const quantity = Number(orderQtyInput && orderQtyInput.value) || 1;
            orderLoading = true;
            orderConfirm.disabled = true;
            orderConfirm.innerHTML = t("product.detail.modal.processing", "Processing...");
            if (orderModalError) orderModalError.textContent = "";
            try {
              const result = await placeOrder(currentProduct.id, quantity);
              if (!result || result.ok === false) {
                throw new Error(
                  result && result.message ? result.message : t("product.detail.toast.orderFailed", "Order failed.")
                );
              }
              closeOrderModal();
              showOrderToast();
            } catch (err) {
              if (orderModalError) {
                orderModalError.textContent =
                  err && err.message ? err.message : t("product.detail.toast.orderFailed", "Order failed.");
              }
              orderConfirm.disabled = false;
              orderConfirm.innerHTML = t("product.detail.modal.confirm", "Confirm order");
              orderLoading = false;
            }
          });
        }

        if (orderBtn) {
          orderBtn.addEventListener(
            "click",
            (event) => {
              if (orderBtn.disabled) return;
              event.preventDefault();
              event.stopPropagation();
              event.stopImmediatePropagation();
              const auth = window.BKAuth ? window.BKAuth.read() : { loggedIn: false };
              if (!auth.loggedIn) {
                const loginMessage = t(
                  "product.detail.toast.loginRequired",
                  "Please log in to place an order."
                );
                if (window.BKAuth && typeof window.BKAuth.redirectToLogin === "function") {
                  window.BKAuth.redirectToLogin(loginMessage);
                } else {
                  notify(loginMessage);
                }
                return;
              }
              openOrderModal();
            },
            true
          );
        }

        const tabs = document.querySelectorAll(".detail-tabs .tab");
        const panels = document.querySelectorAll(".detail-tabs .tab-panel");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const key = tab.dataset.tab;
            tabs.forEach((t) => t.classList.toggle("active", t === tab));
            panels.forEach((p) => p.classList.toggle("active", p.dataset.tab === key));
          });
        });

        const favBtn = document.getElementById("detail-favorite");
        if (favBtn) {
          favBtn.addEventListener("click", () => {
            const active = favBtn.classList.toggle("active");
            favBtn.innerHTML = active
              ? t("product.detail.favorite.active", "Favorited")
              : t("product.detail.favorite", "Favorite");
          });
        }

        const shareBtn = document.getElementById("detail-share");
        if (shareBtn) {
          shareBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(window.location.href);
              shareBtn.innerHTML = t("product.detail.share.copied", "Copied");
              setTimeout(() => {
                shareBtn.innerHTML = t("product.detail.share", "Share");
              }, 1600);
            } catch (e) {
              shareBtn.innerHTML = t("product.detail.share.failed", "Copy failed");
            }
          });
        }

        document.addEventListener("bk:i18n", (event) => {
          currentLanguage =
            (event && event.detail && event.detail.language) ||
            (typeof getCurrentLanguage === "function" ? getCurrentLanguage() : currentLanguage);
          renderProduct(currentProduct);
          if (orderQtyInput) setQty(orderQtyInput.value);
          if (orderConfirm && !orderLoading) {
            orderConfirm.innerHTML = t("product.detail.modal.confirm", "Confirm order");
          }
          if (favBtn) {
            favBtn.innerHTML = favBtn.classList.contains("active")
              ? t("product.detail.favorite.active", "Favorited")
              : t("product.detail.favorite", "Favorite");
          }
          if (shareBtn) shareBtn.innerHTML = t("product.detail.share", "Share");
        });

      })();
    </script>
  </body>
</html>











