<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title data-i18n-key="profile.following.pageTitle">Following | polyflux.xyz</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="../../android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="../../android-chrome-512x512.png" />
    <link rel="manifest" href="../../site.webmanifest" />
    <link rel="icon" href="../../favicon.ico" />
    <meta name="description" content="S&#224;n th&#432;&#417;ng m&#7841;i &#273;i&#7879;n t&#7917; uy t&#237;n, giao nhanh, b&#7843;o h&#224;nh r&#245; r&#224;ng, h&#7895; tr&#7907; 24/7." />
    <meta property="og:title" content="polyflux.xyz" />
    <meta property="og:description" content="S&#224;n th&#432;&#417;ng m&#7841;i &#273;i&#7879;n t&#7917; uy t&#237;n, giao nhanh, b&#7843;o h&#224;nh r&#245; r&#224;ng, h&#7895; tr&#7907; 24/7." />
    <meta property="og:image" content="../../asset/logo-preview.png" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="vi_VN" />
    <meta property="og:site_name" content="polyflux.xyz" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="polyflux.xyz" />
    <meta name="twitter:description" content="S&#224;n th&#432;&#417;ng m&#7841;i &#273;i&#7879;n t&#7917; uy t&#237;n, giao nhanh, b&#7843;o h&#224;nh r&#245; r&#224;ng, h&#7895; tr&#7907; 24/7." />
    <meta name="twitter:image" content="../../asset/logo-preview.png" />
    <link rel="stylesheet" href="../../asset/base.css" />
  </head>
  <body class="page-profile">
    <video class="video-bg" autoplay muted loop playsinline preload="metadata">
      <source src="../../asset/bg-donut.mp4" type="video/mp4" />
    </video>
    <div class="video-overlay"></div>

    <header class="wrap">
      <nav class="nav glass">
        <a href="/" class="brand" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
          <img src="../../asset/logo.png" alt="PolyFlux" />
          <span>polyflux<b>.xyz</b></span>
        </a>
        <div class="nav-links">
          <a href="/sanpham/" data-nav="sanpham">S&#7843;n Ph&#7849;m <span class="badge">HOT</span></a>
          <a href="/dichvu/" data-nav="dichvu">D&#7883;ch V&#7909;</a>
          <a href="/nhiemvu/" data-nav="nhiemvu">Nhi&#7879;m V&#7909;</a>
          <a href="/profile/topups/" data-nav="topups">N&#7841;p ti&#7873;n</a>
        </div>
        <div class="nav-actions">
          <button class="btn balance-btn" data-balance type="button">0 VND</button>
          <a class="btn login-btn" href="/login/">Login</a>
        </div>
      </nav>
    </header>

    <main class="wrap">
      <section class="hero">
        <h1 class="hero-title" data-i18n-key="profile.following.title">Following</h1>
        <p class="hero-sub" data-i18n-key="profile.following.subtitle">Accounts you are following.</p>
      </section>

      <section class="section">
        <div class="card">
          <h3 data-i18n-key="profile.following.listTitle">Following list</h3>
          <div class="message-search following-search">
            <input
              id="following-search"
              type="text"
              placeholder="Search..."
              data-i18n-placeholder="profile.messages.searchPlaceholder"
            />
          </div>
          <div class="following-list" id="following-list"></div>
          <div class="empty-state" id="following-empty" style="margin-top: 12px;">
            <strong data-i18n-key="profile.following.emptyTitle">No data yet.</strong>
            <span data-i18n-key="profile.following.emptyDesc">Follow sellers to find their shops quickly.</span>
          </div>
          <div class="empty-state" id="following-guest" style="margin-top: 12px; display: none;">
            <strong data-i18n-key="profile.following.loginTitle">Please log in</strong>
            <span data-i18n-key="profile.following.loginDesc">Log in to view the accounts you follow.</span>
          </div>
          <div class="table-pagination following-pagination" id="following-pagination" style="margin-top: 14px;"></div>
        </div>
      </section>

      <footer>
        <div class="footer-grid">
          <div>
            <h4>About polyflux.xyz</h4>
            <p>
              The #1 trusted marketplace for digital assets on polyflux.xyz. Buy accounts, emails, tools and more with
              instant delivery.
            </p>
          </div>
          <div>
            <h4>&#272;i&#7873;u h&#432;&#7899;ng</h4>
            <p><a href="/sanpham/">S&#7843;n ph&#7849;m</a></p>
            <p><a href="/dichvu/">D&#7883;ch v&#7909;</a></p>
            <p><a href="/nhiemvu/">Nhi&#7879;m v&#7909; marketplace</a></p>
            <p><a href="/profile/">T&#224;i kho&#7843;n c&#7911;a t&#244;i</a></p>
          </div>
          <div>
            <h4>Thanh to&#225;n &amp; b&#7843;o m&#7853;t</h4>
            <p>20+ ph&#432;&#417;ng th&#7913;c thanh to&#225;n, x&#7917; l&#253; t&#7921; &#273;&#7897;ng.</p>
            <p>L&#7883;ch s&#7917; &#273;&#417;n h&#224;ng minh b&#7841;ch.</p>
            <p>2FA &amp; c&#7843;nh b&#225;o &#273;&#259;ng nh&#7853;p kh&#7843; nghi.</p>
          </div>
          <div>
            <h4>Tham gia b&#225;n h&#224;ng</h4>
            <p>Mu&#7889;n m&#7903; gian h&#224;ng tr&#234;n polyflux.xyz?</p>
            <a href="/seller/join/" class="btn primary" style="margin-top: 8px; display: inline-flex; align-items: center; gap: 6px;">
              Tham gia b&#225;n h&#224;ng
            </a>
          </div>
        </div>
      </footer>
    </main>

    <nav class="mobile-nav">
      <div class="mobile-nav-top">
        <a href="/" class="mobile-brand" style="display: flex; align-items: center; gap: 10px; text-decoration: none;">
          <img src="../../asset/logo.png" alt="PolyFlux" />
          <span>polyflux<b>.xyz</b></span>
        </a>
        <div class="mobile-actions">
          <button class="btn balance-btn" data-balance type="button">0 VND</button>
          <a class="btn login-btn" href="/login/">Login</a>

          <button class="menu-btn" id="mobile-menu" type="button" aria-label="Menu">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
      </div>
      <div class="mobile-links">
        <a href="/sanpham/" data-nav="sanpham">S&#7843;n Ph&#7849;m</a>
        <a href="/dichvu/" data-nav="dichvu">D&#7883;ch V&#7909;</a>
        <a href="/nhiemvu/" data-nav="nhiemvu">Nhi&#7879;m V&#7909;</a>
        <a href="/profile/topups/" data-nav="topups">N&#7841;p ti&#7873;n</a>
      </div>
    </nav>

    <script src="../../asset/render.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const auth = window.BKAuth ? window.BKAuth.read() : { loggedIn: false, user: null };
        const listEl = document.getElementById("following-list");
        const emptyEl = document.getElementById("following-empty");
        const emptyTitle = emptyEl ? emptyEl.querySelector("strong") : null;
        const emptyDesc = emptyEl ? emptyEl.querySelector("span") : null;
        const guestEl = document.getElementById("following-guest");
        const searchInput = document.getElementById("following-search");
        const paginationEl = document.getElementById("following-pagination");
        const root = typeof getRootPath === "function" ? getRootPath() : "/";
        const apiUrl = root + "api/following";
        const fallbackAvatar = root + "asset/avt-macdinh.jpg";
        const isFile = window.location.protocol === "file:";
        const getAvatar = typeof getAvatarUrl === "function" ? getAvatarUrl : (user) => (user && user.avatar_url ? String(user.avatar_url) : fallbackAvatar);
        const uiKit = window.BKUI || {};
        const applyNameWithBadge = typeof uiKit.applyNameWithBadge === "function" ? uiKit.applyNameWithBadge : null;
        const isAdminUser = typeof uiKit.isAdminUser === "function" ? uiKit.isAdminUser : null;
        const isValidUsername = (value) => /^[a-z0-9._-]{3,20}$/.test(value);
        const buildProfileUrl = (username) =>
          isFile ? `${root}profile/public/index.html?u=${encodeURIComponent(username)}` : `${root}u/${encodeURIComponent(username)}`;
        const hideEl = (el, hide) => {
          if (!el) return;
          el.style.display = hide ? "none" : "";
        };
        const parsePositiveInt = (value, fallback) => {
          const parsed = Number.parseInt(value, 10);
          if (!Number.isFinite(parsed) || parsed < 1) return fallback;
          return parsed;
        };
        const debounce = (fn, delay) => {
          let timer = null;
          return (...args) => {
            if (timer) window.clearTimeout(timer);
            timer = window.setTimeout(() => fn(...args), delay);
          };
        };

        if (!auth || !auth.loggedIn || !auth.user || auth.user.id == null) {
          hideEl(guestEl, false);
          hideEl(emptyEl, true);
          return;
        }

        const state = {
          page: 1,
          q: "",
          totalPages: 0,
        };
        const limit = 15;
        const params = new URLSearchParams(window.location.search);
        state.q = (params.get("q") || "").trim();
        state.page = parsePositiveInt(params.get("page"), 1);
        if (searchInput) searchInput.value = state.q;

        const syncQueryString = () => {
          if (isFile) return;
          const next = new URLSearchParams();
          if (state.q) next.set("q", state.q);
          if (state.page > 1) next.set("page", String(state.page));
          const suffix = next.toString();
          const url = `${window.location.pathname}${suffix ? `?${suffix}` : ""}`;
          window.history.replaceState({}, "", url);
        };

        const renderEmpty = (hasItems) => {
          hideEl(emptyEl, hasItems);
          if (hasItems || !emptyEl) return;
          if (state.q) {
            if (emptyTitle) emptyTitle.textContent = "Khong tim thay ket qua";
            if (emptyDesc) emptyDesc.textContent = "Thu tim tu khoa khac.";
            return;
          }
          if (emptyTitle) emptyTitle.textContent = "Chua theo doi ai";
          if (emptyDesc) emptyDesc.textContent = "Theo doi tai khoan de hien thi o day.";
        };

        const renderList = (users) => {
          if (!listEl) return;
          listEl.innerHTML = "";
          const items = Array.isArray(users) ? users : [];
          items.forEach((item) => {
            const username = item && item.username ? String(item.username).trim().toLowerCase() : "";
            if (!username || !isValidUsername(username)) return;
            const display = item.display_name ? String(item.display_name).trim() : username;
            const avatar = getAvatar(item);

            const card = document.createElement("a");
            card.className = "following-item";
            card.href = buildProfileUrl(username);

            const info = document.createElement("div");
            info.className = "following-info";

            const img = document.createElement("img");
            img.className = "following-avatar";
            img.src = avatar;
            img.alt = display;
            img.loading = "lazy";

            const text = document.createElement("div");
            text.className = "following-text";

            const name = document.createElement("strong");
            const isAdmin =
              typeof isAdminUser === "function"
                ? isAdminUser(item)
                : String(item && item.role ? item.role : "")
                    .trim()
                    .toLowerCase() === "admin" ||
                  String(item && item.username ? item.username : "")
                    .trim()
                    .toLowerCase() === "admin";
            if (applyNameWithBadge) {
              applyNameWithBadge(name, { name: display, isAdmin });
            } else {
              name.textContent = display;
            }

            const handle = document.createElement("span");
            handle.textContent = `@${username}`;

            const view = document.createElement("span");
            view.className = "following-link";
            view.textContent = "Xem";

            text.appendChild(name);
            text.appendChild(handle);
            info.appendChild(img);
            info.appendChild(text);
            card.appendChild(info);
            card.appendChild(view);
            listEl.appendChild(card);
          });

          const hasItems = listEl.children.length > 0;
          renderEmpty(hasItems);
        };

        const buildPageList = (current, total) => {
          if (total <= 1) return [];
          if (total <= 7) return Array.from({ length: total }, (_, idx) => idx + 1);
          if (current <= 4) return [1, 2, 3, 4, 5, "ellipsis", total];
          if (current >= total - 3) return [1, "ellipsis", total - 4, total - 3, total - 2, total - 1, total];
          return [1, "ellipsis", current - 1, current, current + 1, "ellipsis", total];
        };

        const renderPagination = () => {
          if (!paginationEl) return;
          paginationEl.innerHTML = "";
          if (!state.totalPages || state.totalPages <= 1) return;
          const addButton = (label, page, disabled, active) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = `btn ghost${active ? " is-active" : ""}`;
            btn.textContent = label;
            if (Number.isFinite(page)) btn.dataset.page = String(page);
            if (disabled) {
              btn.disabled = true;
              btn.setAttribute("aria-disabled", "true");
            }
            if (active) btn.setAttribute("aria-current", "page");
            paginationEl.appendChild(btn);
          };

          addButton("Prev", state.page - 1, state.page <= 1, false);
          buildPageList(state.page, state.totalPages).forEach((item) => {
            if (item === "ellipsis") {
              const span = document.createElement("span");
              span.className = "pagination-ellipsis";
              span.textContent = "...";
              paginationEl.appendChild(span);
              return;
            }
            const pageNum = Number(item);
            addButton(String(pageNum), pageNum, false, pageNum === state.page);
          });
          addButton("Next", state.page + 1, state.page >= state.totalPages, false);
        };

        const loadFollowing = async () => {
          try {
            const query = new URLSearchParams();
            query.set("userId", String(auth.user.id));
            query.set("page", String(state.page));
            query.set("limit", String(limit));
            if (state.q) query.set("q", state.q);
            const response = await fetch(`${apiUrl}?${query.toString()}`);
            const data = await response.json().catch(() => null);
            if (!response.ok || !data || !data.ok) {
              state.totalPages = 0;
              renderList([]);
              renderPagination();
              return;
            }
            const items = Array.isArray(data.items) ? data.items : Array.isArray(data.users) ? data.users : [];
            state.page = parsePositiveInt(data.page, state.page);
            state.totalPages = Number.isFinite(Number(data.totalPages)) ? Number(data.totalPages) : 0;
            renderList(items);
            renderPagination();
            syncQueryString();
          } catch (error) {
            state.totalPages = 0;
            renderList([]);
            renderPagination();
          }
        };

        if (searchInput) {
          const onSearch = debounce((value) => {
            state.q = String(value || "").trim();
            state.page = 1;
            loadFollowing();
          }, 300);
          searchInput.addEventListener("input", (event) => {
            onSearch(event.target ? event.target.value : "");
          });
        }

        if (paginationEl) {
          paginationEl.addEventListener("click", (event) => {
            const btn = event.target.closest("button[data-page]");
            if (!btn || btn.disabled) return;
            const nextPage = parsePositiveInt(btn.dataset.page, state.page);
            if (nextPage === state.page) return;
            state.page = nextPage;
            loadFollowing();
          });
        }

        loadFollowing();
      });
    </script>
  </body>
</html>

