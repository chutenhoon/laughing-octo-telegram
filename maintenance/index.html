<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>B&#7843;o tr&#236; | polyflux.xyz</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="../android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="../android-chrome-512x512.png" />
    <link rel="manifest" href="../site.webmanifest" />
    <link rel="icon" href="../favicon.ico" />
    <meta name="description" content="H&#7879; th&#7889;ng &#273;ang b&#7843;o tr&#236; t&#7841;m th&#7901;i. Vui l&#242;ng quay l&#7841;i sau." />
    <link rel="stylesheet" href="../asset/base.css" />
    <style>
      body {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 32px 16px;
      }

      .maintenance-shell {
        width: min(880px, 94vw);
      }

      .maintenance-card {
        padding: 28px;
        border-radius: 22px;
        border: 1px solid var(--stroke);
        background: rgba(12, 12, 18, 0.9);
        box-shadow: var(--shadow);
      }

      .maintenance-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(139, 124, 255, 0.12);
        color: var(--accent);
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.4px;
        text-transform: uppercase;
      }

      .maintenance-title {
        margin: 16px 0 10px;
        font-size: clamp(22px, 3.2vw, 30px);
        font-weight: 800;
        font-family: "Outfit", sans-serif;
      }

      .maintenance-message {
        color: var(--muted);
        font-size: 14px;
        line-height: 1.7;
      }

      .maintenance-meta {
        margin-top: 20px;
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .maintenance-meta-item {
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid var(--soft);
        background: rgba(10, 10, 16, 0.7);
        display: grid;
        gap: 6px;
      }

      .maintenance-meta-item span {
        font-size: 12px;
        color: var(--muted);
      }

      .maintenance-meta-item strong {
        font-size: 15px;
        font-weight: 700;
        color: var(--text);
      }

      .maintenance-actions {
        margin-top: 22px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .maintenance-note {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <main class="maintenance-shell">
      <section class="maintenance-card glass">
        <div class="maintenance-pill" id="maintenance-status">B&#7843;o tr&#236;</div>
        <h1 class="maintenance-title">H&#7879; th&#7889;ng &#273;ang b&#7843;o tr&#236;</h1>
        <p class="maintenance-message" id="maintenance-message">
          B&#7843;o tr&#236; h&#7879; th&#7889;ng, xin l&#7895;i v&#236; s&#7921; b&#7845;t ti&#7879;n n&#224;y.
        </p>
        <div class="maintenance-meta">
          <div class="maintenance-meta-item">
            <span>Khu v&#7921;c</span>
            <strong id="maintenance-scope">&#272;ang c&#7853;p nh&#7853;t</strong>
          </div>
          <div class="maintenance-meta-item">
            <span>C&#242;n l&#7841;i</span>
            <strong id="maintenance-countdown">--:--</strong>
          </div>
          <div class="maintenance-meta-item">
            <span>Ho&#224;n t&#7845;t l&#250;c</span>
            <strong id="maintenance-end">--</strong>
          </div>
        </div>
        <div class="maintenance-actions">
          <a class="btn ghost" id="maintenance-home" href="/">V&#7873; trang ch&#7911;</a>
          <button class="btn primary" id="maintenance-refresh" type="button">Th&#7917; l&#7841;i</button>
        </div>
        <div class="maintenance-note" id="maintenance-note">
          Trang s&#7869; t&#7921; l&#224;m m&#7899;i khi h&#7871;t th&#7901;i gian b&#7843;o tr&#236;.
        </div>
      </section>
    </main>

    <script>
      (function () {
        const messageEl = document.getElementById("maintenance-message");
        const statusEl = document.getElementById("maintenance-status");
        const scopeEl = document.getElementById("maintenance-scope");
        const countdownEl = document.getElementById("maintenance-countdown");
        const endEl = document.getElementById("maintenance-end");
        const homeLink = document.getElementById("maintenance-home");
        const refreshBtn = document.getElementById("maintenance-refresh");
        const noteEl = document.getElementById("maintenance-note");

        const labels = [
          { match: "/sanpham/", label: "S\u1ea3n ph\u1ea9m" },
          { match: "/dichvu/", label: "D\u1ecbch v\u1ee5" },
          { match: "/nhiemvu/tao/", label: "\u0110\u0103ng b\u00e0i nhi\u1ec7m v\u1ee5" },
          { match: "/nhiemvu/", label: "Marketplace / Nhi\u1ec7m v\u1ee5" },
          { match: "/seller/panel/", label: "Panel seller" },
          { match: "/profile/", label: "H\u1ed3 s\u01a1 / T\u00e0i kho\u1ea3n" },
          { match: "/checkout/", label: "Thanh to\u00e1n" },
          { match: "/", label: "To\u00e0n b\u1ed9 website" },
        ];

        let serverOffset = 0;
        let endAt = null;
        let countdownTimer = null;
        let safeFrom = "/";

        const normalizePath = (value) => {
          if (!value) return "";
          if (value.startsWith("http://") || value.startsWith("https://")) return "";
          if (!value.startsWith("/")) return "";
          return value.replace(/[^a-zA-Z0-9/_\\-]/g, "") || "/";
        };

        const resolveLabel = (path) => {
          const clean = (path || "/").toLowerCase();
          const match = labels.find((item) => clean.startsWith(item.match));
          return match ? match.label : "To\u00e0n b\u1ed9 website";
        };

        const pad = (num) => String(num).padStart(2, "0");

        const formatTime = (value) => {
          if (!value) return "--";
          try {
            return new Date(value).toLocaleString("vi-VN", {
              hour12: false,
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });
          } catch (error) {
            return "--";
          }
        };

        const updateCountdown = () => {
          if (!endAt) {
            countdownEl.textContent = "--:--";
            return;
          }
          const now = Date.now() + serverOffset;
          let remaining = endAt - now;
          if (remaining <= 0) {
            countdownEl.textContent = "00:00";
            if (countdownTimer) {
              clearInterval(countdownTimer);
              countdownTimer = null;
            }
            if (safeFrom) {
              window.location.href = safeFrom;
            } else {
              window.location.reload();
            }
            return;
          }
          remaining = Math.floor(remaining / 1000);
          const hours = Math.floor(remaining / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          const seconds = remaining % 60;
          countdownEl.textContent = hours ? `${pad(hours)}:${pad(minutes)}:${pad(seconds)}` : `${pad(minutes)}:${pad(seconds)}`;
        };

        const applyConfig = (config, serverTime) => {
          const message = config && config.message ? config.message : "";
          if (messageEl && message) messageEl.textContent = message;
          serverOffset = (serverTime || Date.now()) - Date.now();
          endAt = config && Number.isFinite(Number(config.endAt)) ? Number(config.endAt) : null;
          const active = config && config.active === true;
          if (statusEl) {
            statusEl.textContent = active ? "Dang bao tri" : "Dang hoat dong";
            statusEl.style.color = active ? "var(--accent)" : "var(--accent-2)";
            statusEl.style.background = active ? "rgba(139, 124, 255, 0.12)" : "rgba(92, 192, 255, 0.12)";
          }
          if (endEl) endEl.textContent = endAt ? formatTime(endAt) : "--";
          updateCountdown();
          if (endAt && !countdownTimer) {
            countdownTimer = setInterval(updateCountdown, 1000);
          }
          if (!active && noteEl) {
            noteEl.textContent = "H\u1ec7 th\u1ed1ng \u0111\u00e3 s\u1eb5n s\u00e0ng. B\u1ea1n c\u00f3 th\u1ec3 quay l\u1ea1i.";
          }
        };

        const fromParam = new URLSearchParams(window.location.search || "").get("from");
        safeFrom = normalizePath(fromParam) || "/";
        if (homeLink) homeLink.href = safeFrom || "/";
        if (scopeEl) scopeEl.textContent = resolveLabel(safeFrom);

        if (refreshBtn) {
          refreshBtn.addEventListener("click", () => {
            if (safeFrom) {
              window.location.href = safeFrom;
            } else {
              window.location.reload();
            }
          });
        }

        fetch("/api/maintenance", { cache: "no-store" })
          .then((res) => (res.ok ? res.json() : Promise.reject(new Error("maintenance_fetch_failed"))))
          .then((data) => {
            const config = data && data.config ? data.config : {};
            const serverTime = data && data.serverTime ? Number(data.serverTime) : Date.now();
            applyConfig(config, serverTime);
          })
          .catch(() => {
            applyConfig({}, Date.now());
          });
      })();
    </script>
  </body>
</html>
